<!DOCTYPE html>
<html>
    <head>
        <meta charset="UTF-8">
        <title>ELPiTiFOR's Blog</title>
        <link href="../../../styles.css" rel="stylesheet">
    </head>
    <body>
        <header class="mainHeader">
            <h1>ObsCure: Digging into the executable by ELPiTiFOR</h1>
            <div class="headerLinks">
                <a href="../../../index.html"><button>Start</button></a>
                <a href="../index.html"><button>Start ObsCure Reversing</button></a>
                <a href="index.html"><button>Exe Insides</button></a>
            </div>
        </header>
        <main class="mainContentContainer">
            <div class="mainContent">
                <h2>Saving the game</h2>
                <p>
                    After trying very hard to understand the format of the `.hoe` files only by reading and modifying the
                    files themselves, I considered it was time to try to look at how the game reads these files, that
                    means digging into the executable file, and try to find some function that would parse the `.hoe`
                    files. But since I had never tried to figure out the format of a file by reading the assembly and by
                    debugging the game, I thought that it would be better to start with some file format that I already
                    knew, so as to get used to looking for classes and structures in the binary (it is easier to
                    recognize patterns or attributes if you already know the format). So I started reversing the `.sav`
                    format via debugging, since I knew most of it.
                </p>
                <p>
                    Let's make a quick summary of the contents of the `.sav` files. As a survival horror, ObsCure needs
                    to save the following information:
                </p>
                <ul>
                    <li>What items where picked up in each room</li>
                    <li>What doors are open</li>
                    <li>The health, location, (X, Y, Z) position, etc of each character</li>
                    <li>The amount of ammunition per gun type</li>
                    <li>The amount of ammunition in each gun</li>
                    <li>The weapons inventory of each character</li>
                    <li>The items inventory (shared among all characters)</li>
                    <li>...</li>
                </ul>
                <p>
                    How is all of this organized in the `.sav` format? To sum it up, first we have some general information
                    on the game, like the difficulty, the play time, the room in which the player saved the game, etc. Then
                    we have the items inventory, so we have all the puzzle items, the keys, the health items, etc. After
                    that we have the information of each character (health, location, etc) and their weapons inventories.
                    Finally, the rest of the file stores information on the progress in the game and the items that were
                    picked up in each room.
                </p>
                <p>
                    Not only did I know most of the `.sav` format, but when saving the progress, ObsCure needs to write
                    to a file, so it uses the `WriteFile` function of the Windows API, which unlike most functions in
                    the binary, is named. So I could easily identify the function that saves the content to a `game?.sav`
                    file (where "?" is a digit between `0` and `9`): I only needed to set 3 breakpoints, one per each
                    call to the `WriteFile` function, save the progress in the game, and note which breakpoint was
                    reached.
                </p>
                <p>
                    Once I located the piece of code that wrote the content to the `.sav` file, my objective was to
                    determine how the game decides what contents, what array of bytes should be written into the
                    files. In order to write to a file, you first need to know what to write, you need to fill a
                    buffer with the content you want to write.
                </p>
            </div>
        </main>
    </body>
</html>